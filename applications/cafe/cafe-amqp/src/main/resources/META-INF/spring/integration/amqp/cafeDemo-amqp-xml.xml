<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="https://www.springframework.org/schema/beans"
	xmlns:xsi="https://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="https://www.springframework.org/schema/integration"
	xmlns:int-amqp="https://www.springframework.org/schema/integration/amqp"
	xmlns:rabbit="https://www.springframework.org/schema/rabbit"
	xmlns:int-stream="https://www.springframework.org/schema/integration/stream"
	xmlns:cloud="https://schema.cloudfoundry.org /spring"
	xsi:schemaLocation="https://www.springframework.org/schema/beans
			https://www.springframework.org/schema/beans/spring-beans.xsd
			https://schema.cloudfoundry.org/spring
			https://schema.cloudfoundry.org/spring/cloudfoundry-spring.xsd
			https://www.springframework.org/schema/integration
			https://www.springframework.org/schema/integration/spring-integration.xsd
			https://www.springframework.org/schema/integration/amqp
			https://www.springframework.org/schema/integration/amqp/spring-integration-amqp.xsd
			https://www.springframework.org/schema/rabbit
			https://www.springframework.org/schema/rabbit/spring-rabbit.xsd
			https://www.springframework.org/schema/integration/stream
			https://www.springframework.org/schema/integration/stream/spring-integration-stream.xsd">

	<!-- rabbit connection factory, rabbit template, and rabbit admin -->
	<import resource="classpath:META-INF/spring/integration/amqp/cafeDemo-amqp-config-xml.xml" />

	<!-- spring integration flow -->
	<int:gateway id="cafe" service-interface="org.springframework.integration.samples.cafe.Cafe" />

	<int:channel id="orders"/>

	<int:header-enricher input-channel="orders" output-channel="newOrders">
		<int:header name="NUMBER" expression="payload.getNumber()"/>
	</int:header-enricher>

	<int:object-to-json-transformer input-channel="newOrders" output-channel="jsonNewOrders" content-type="text/x-json"/>

	<int:channel id="jsonNewOrders" />

	<!--  To send AMQP Messages to an Exchange, configure an outbound-channel-adapter. -->
	<int-amqp:outbound-channel-adapter
		channel="jsonNewOrders"
		exchange-name="cafe-orders"
		routing-key-expression="'order.'+headers.NUMBER"
		amqp-template="amqpTemplate" />

	<!-- rabbit exchanges, queues, and bindings used by this app -->
	<rabbit:topic-exchange name="cafe-orders" auto-delete="false" durable="true">
		<rabbit:bindings>
			<rabbit:binding queue="new-orders" pattern="order.*"/>
			<rabbit:binding queue="all-orders" pattern="order.*"/>
		</rabbit:bindings>
	</rabbit:topic-exchange>

	<rabbit:queue name="new-orders" auto-delete="false" durable="true"/>
	<rabbit:queue name="all-orders" auto-delete="false" durable="true"/>

</beans>